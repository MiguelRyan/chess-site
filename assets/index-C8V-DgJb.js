var Le=Object.defineProperty;var Oe=(h,e,t)=>e in h?Le(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var _=(h,e,t)=>Oe(h,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const X={start:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",empty:"8/8/8/8/8/8/8/8"};class y{constructor(e=X.empty){this.squares=new Array(64).fill(null),this.setFen(e)}setFen(e=X.empty){const t=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let s=0;s<8;s++){const i=t[7-s].replace(/\d/g,r=>{const o=parseInt(r);let n="";for(let a=0;a<o;a++)n+="-";return n});for(let r=0;r<8;r++){const o=i.substring(r,r+1);let n=null;o!=="-"&&(o.toUpperCase()===o?n=`w${o.toLowerCase()}`:n=`b${o}`),this.squares[s*8+r]=n}}}getFen(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let i=0;i<8;i++){const r=this.squares[t*8+i];if(!r)s++;else{s>0&&(e[7-t]+=s,s=0);const o=r.substring(0,1),n=r.substring(1,2);o==="w"?e[7-t]+=n.toUpperCase():e[7-t]+=n}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}getPieces(e=void 0,t=void 0,s=["k","q","r","b","n","p"]){const i=[],r=(o,n)=>s.indexOf(o.name)-s.indexOf(n.name);for(let o=0;o<64;o++){const n=this.squares[o];if(n){const a=n.charAt(1),c=n.charAt(0),f=y.indexToSquare(o);if(t&&t!==a||e&&e!==c)continue;i.push({name:a,type:a,color:c,position:f,square:f})}}return s&&i.sort(r),i}movePiece(e,t){if(!this.squares[y.squareToIndex(e)]){console.warn("no piece on",e);return}this.squares[y.squareToIndex(t)]=this.squares[y.squareToIndex(e)],this.squares[y.squareToIndex(e)]=null}setPiece(e,t){this.squares[y.squareToIndex(e)]=t}getPiece(e){return this.squares[y.squareToIndex(e)]}static squareToIndex(e){const t=y.squareToCoordinates(e);return t[0]+t[1]*8}static indexToSquare(e){return this.coordinatesToSquare([Math.floor(e%8),e/8])}static squareToCoordinates(e){const t=e.charCodeAt(0)-97,s=e.charCodeAt(1)-49;return[t,s]}static coordinatesToSquare(e){const t=String.fromCharCode(e[0]+97),s=String.fromCharCode(e[1]+49);return t+s}toString(){return this.getFen()}clone(){const e=new y;return e.squares=this.squares.slice(0),e}}class De{constructor(){this.position=new y,this.orientation=void 0,this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.squareSelectEnabled=!1,this.moveInputCallback=null,this.extensionPoints={},this.moveInputProcess=Promise.resolve()}inputEnabled(){return this.inputWhiteEnabled||this.inputBlackEnabled}invokeExtensionPoints(e,t={}){const s=this.extensionPoints[e],i=Object.assign({},t);i.extensionPoint=e;let r=!0;if(s)for(const o of s)o(i)===!1&&(r=!1);return r}}const Ee="http://www.w3.org/2000/svg";class b{static createSvg(e=void 0){let t=document.createElementNS(Ee,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s={}){let i=document.createElementNS(Ee,t);t==="use"&&(s["xlink:href"]=s.href);for(let r in s)if(s.hasOwnProperty(r))if(r.indexOf(":")!==-1){const o=r.split(":");i.setAttributeNS("http://www.w3.org/1999/"+o[0],o[1],s[r])}else i.setAttribute(r,s[r]);return e.appendChild(i),i}static removeElement(e){if(!e){console.warn("removeElement, element is",e);return}e.parentNode?e.parentNode.removeChild(e):console.warn(e,"without parentNode")}}const w={positionChanged:"positionChanged",boardChanged:"boardChanged",moveInputToggled:"moveInputToggled",moveInput:"moveInput",beforeRedrawBoard:"beforeRedrawBoard",afterRedrawBoard:"afterRedrawBoard",redrawBoard:"redrawBoard",animation:"animation",destroy:"destroy"};class Te{constructor(e){this.chessboard=e}registerExtensionPoint(e,t){e===w.redrawBoard&&(console.warn("EXTENSION_POINT.redrawBoard is deprecated, use EXTENSION_POINT.afterRedrawBoard"),e=w.afterRedrawBoard),this.chessboard.state.extensionPoints[e]||(this.chessboard.state.extensionPoints[e]=[]),this.chessboard.state.extensionPoints[e].push(t)}registerMethod(e,t){console.warn("registerMethod is deprecated, just add methods directly to the chessboard instance"),this.chessboard[e]?log.error("method",e,"already exists"):this.chessboard[e]=(...s)=>t.apply(this,s)}}class z{static delegate(e,t,s,i){const r=function(o){let n=o.target;for(;n&&n!==this;)n.matches(s)&&i.call(n,o),n=n.parentNode};return e.addEventListener(t,r),{remove:function(){e.removeEventListener(t,r)}}}static mergeObjects(e,t){const s=i=>i&&typeof i=="object";if(!s(e)||!s(t))return t;for(const i of Object.keys(t))t[i]instanceof Object&&Object.assign(t[i],z.mergeObjects(e[i],t[i]));return Object.assign(e||{},t),e}static createDomElement(e){const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild}static createTask(){let e,t;const s=new Promise(function(i,r){e=i,t=r});return s.resolve=e,s.reject=t,s}static isAbsoluteUrl(e){return e.indexOf("://")!==-1||e.startsWith("/")}}const le={start:"start",frame:"frame",end:"end"};class Ne{constructor(){this.queue=[],this.workingOnPromise=!1,this.stop=!1}async enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}dequeue(){if(this.workingOnPromise)return;if(this.stop){this.queue=[],this.stop=!1;return}const e=this.queue.shift();if(e){try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}}destroy(){this.stop=!0}}const F={move:0,appear:1,disappear:2};class Y{constructor(e,t,s,i,r){this.view=e,t&&s?(this.animatedElements=this.createAnimation(t.squares,s.squares),this.duration=i,this.callback=r,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this))):console.error("fromPosition",t,"toPosition",s),this.view.positionsAnimationTask=z.createTask(),this.view.chessboard.state.invokeExtensionPoints(w.animation,{type:le.start})}static seekChanges(e,t){const s=[],i=[],r=[];for(let o=0;o<64;o++){const n=e[o],a=t[o];a!==n&&(a&&s.push({piece:a,index:o}),n&&i.push({piece:n,index:o}))}return s.forEach(o=>{let n=8,a=null;i.forEach(c=>{if(o.piece===c.piece){const f=Y.squareDistance(o.index,c.index);f<n&&(a=c,n=f)}}),a?(i.splice(i.indexOf(a),1),r.push({type:F.move,piece:o.piece,atIndex:a.index,toIndex:o.index})):r.push({type:F.appear,piece:o.piece,atIndex:o.index})}),i.forEach(o=>{r.push({type:F.disappear,piece:o.piece,atIndex:o.index})}),r}createAnimation(e,t){const s=Y.seekChanges(e,t),i=[];return s.forEach(r=>{const o={type:r.type};switch(r.type){case F.move:o.element=this.view.getPieceElement(y.indexToSquare(r.atIndex)),o.element.parentNode.appendChild(o.element),o.atPoint=this.view.indexToPoint(r.atIndex),o.toPoint=this.view.indexToPoint(r.toIndex);break;case F.appear:o.element=this.view.drawPieceOnSquare(y.indexToSquare(r.atIndex),r.piece),o.element.style.opacity=0;break;case F.disappear:o.element=this.view.getPieceElement(y.indexToSquare(r.atIndex));break}i.push(o)}),i}animationStep(e){if(!this.view||!this.view.chessboard.state)return;this.startTime||(this.startTime=e);const t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.animatedElements.forEach(r=>{r.type===F.disappear&&b.removeElement(r.element)}),this.view.positionsAnimationTask.resolve(),this.view.chessboard.state.invokeExtensionPoints(w.animation,{type:le.end}),this.callback();return}const s=Math.min(1,t/this.duration);let i=s<.5?2*s*s:-1+(4-2*s)*s;(isNaN(i)||i>.99)&&(i=1),this.animatedElements.forEach(r=>{if(r.element)switch(r.type){case F.move:r.element.transform.baseVal.removeItem(0);const o=this.view.svg.createSVGTransform();o.setTranslate(r.atPoint.x+(r.toPoint.x-r.atPoint.x)*i,r.atPoint.y+(r.toPoint.y-r.atPoint.y)*i),r.element.transform.baseVal.appendItem(o);break;case F.appear:r.element.style.opacity=Math.round(i*100)/100;break;case F.disappear:r.element.style.opacity=Math.round((1-i)*100)/100;break}else console.warn("animatedItem has no element",r)}),this.view.chessboard.state.invokeExtensionPoints(w.animation,{type:le.frame,progress:i})}static squareDistance(e,t){const s=e%8,i=Math.floor(e/8),r=t%8,o=Math.floor(t/8);return Math.max(Math.abs(o-i),Math.abs(r-s))}}class Re extends Ne{constructor(e){super(),this.chessboard=e}async enqueuePositionChange(e,t,s){return e.getFen()===t.getFen()?Promise.resolve():super.enqueue(()=>new Promise(i=>{let r=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(r=r/(1+Math.pow(this.queue.length/5,2))),new Y(this.chessboard.view,e,t,s?r:0,()=>{this.chessboard.view&&this.chessboard.view.redrawPieces(t.squares),i()})}))}async enqueueTurnBoard(e,t,s){return super.enqueue(()=>new Promise(i=>{const r=new y(X.empty);let o=s?this.chessboard.props.style.animationDuration:0;this.queue.length>0&&(o=o/(1+Math.pow(this.queue.length/5,2))),new Y(this.chessboard.view,e,r,s?o:0,()=>{this.chessboard.state.orientation=t,this.chessboard.view.redrawBoard(),this.chessboard.view.redrawPieces(r.squares),new Y(this.chessboard.view,r,e,s?o:0,()=>{this.chessboard.view.redrawPieces(e.squares),i()})})}))}}const u={waitForInputStart:"waitForInputStart",pieceClickedThreshold:"pieceClickedThreshold",clickTo:"clickTo",secondClickThreshold:"secondClickThreshold",dragTo:"dragTo",clickDragTo:"clickDragTo",moveDone:"moveDone",reset:"reset"},J={secondClick:"secondClick",secondaryClick:"secondaryClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnotherPiece:"clickedAnotherPiece"},ye=4;class Be{constructor(e){this.view=e,this.chessboard=e.chessboard,this.moveInputState=null,this.fromSquare=null,this.toSquare=null,this.setMoveInputState(u.waitForInputStart)}moveInputStartedCallback(e){const t=this.view.moveInputStartedCallback(e);return t&&(this.chessboard.state.moveInputProcess=z.createTask(),this.chessboard.state.moveInputProcess.then(s=>{(this.moveInputState===u.waitForInputStart||this.moveInputState===u.moveDone)&&this.view.moveInputFinishedCallback(this.fromSquare,this.toSquare,s)})),t}movingOverSquareCallback(e,t){this.view.movingOverSquareCallback(e,t)}validateMoveInputCallback(e,t){const s=this.view.validateMoveInputCallback(e,t);return this.chessboard.state.moveInputProcess.resolve(s),s}moveInputCanceledCallback(e,t,s){this.view.moveInputCanceledCallback(e,t,s),this.chessboard.state.moveInputProcess.resolve()}setMoveInputState(e,t=void 0){const s=this.moveInputState;switch(this.moveInputState=e,e){case u.waitForInputStart:break;case u.pieceClickedThreshold:if(u.waitForInputStart!==s&&u.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.fromSquare=t.square,this.toSquare=null,this.movedPiece=t.piece,this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener){if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("4b74af");this.contextMenuListener||(this.contextMenuListener=this.onContextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener))}else throw Error("94ad0c");break;case u.clickTo:this.draggablePiece&&(b.removeElement(this.draggablePiece),this.draggablePiece=null),s===u.dragTo&&this.view.setPieceVisibility(t.square,!0);break;case u.secondClickThreshold:if(u.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case u.dragTo:if(u.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case u.clickDragTo:if(u.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled()&&(this.view.setPieceVisibility(t.square,!1),this.createDraggablePiece(t.piece));break;case u.moveDone:if([u.dragTo,u.clickTo,u.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");this.toSquare=t.square,this.toSquare&&this.validateMoveInputCallback(this.fromSquare,this.toSquare)?this.chessboard.movePiece(this.fromSquare,this.toSquare,s===u.clickTo).then(()=>{s===u.clickTo&&this.view.setPieceVisibility(this.toSquare,!0),this.setMoveInputState(u.reset)}):(this.view.setPieceVisibility(this.fromSquare,!0),this.setMoveInputState(u.reset));break;case u.reset:this.fromSquare&&!this.toSquare&&this.movedPiece&&this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.fromSquare=null,this.toSquare=null,this.movedPiece=null,this.draggablePiece&&(b.removeElement(this.draggablePiece),this.draggablePiece=null),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=null),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=null),this.contextMenuListener&&(removeEventListener("contextmenu",this.contextMenuListener),this.contextMenuListener=null),this.setMoveInputState(u.waitForInputStart);const i=this.view.piecesGroup.querySelectorAll("[visibility=hidden]");for(let r=0;r<i.length;r++)i[r].removeAttribute("visibility");break;default:throw Error(`260b09: moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece already exists");this.draggablePiece=b.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;const t=this.chessboard.props.assetsCache?"":this.view.getSpriteUrl(),s=b.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),i=this.view.squareHeight/this.chessboard.props.style.pieces.tileSize,r=this.draggablePiece.createSVGTransform();r.setScale(i,i),s.transform.baseVal.appendItem(r)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(!(e.type==="mousedown"&&e.button===0||e.type==="touchstart"))return;const t=e.target.getAttribute("data-square");if(!t)return;const s=this.chessboard.getPiece(t);let i;if(s&&(i=s?s.substring(0,1):null,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),this.moveInputState!==u.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b"){let r;if(e.type==="mousedown"?r={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(r={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===u.waitForInputStart&&s&&this.moveInputStartedCallback(t))this.setMoveInputState(u.pieceClickedThreshold,{square:t,piece:s,point:r,type:e.type});else if(this.moveInputState===u.clickTo)if(t===this.fromSquare)this.setMoveInputState(u.secondClickThreshold,{square:t,piece:s,point:r,type:e.type});else{const o=this.chessboard.getPiece(t),n=o?o.substring(0,1):null,a=this.chessboard.getPiece(this.fromSquare),c=a?a.substring(0,1):null;i&&c===n?(this.moveInputCanceledCallback(this.fromSquare,t,J.clickedAnotherPiece),this.moveInputStartedCallback(t)?this.setMoveInputState(u.pieceClickedThreshold,{square:t,piece:o,point:r,type:e.type}):this.setMoveInputState(u.reset)):this.setMoveInputState(u.moveDone,{square:t})}}}onPointerMove(e){let t,s,i,r,o;if(e.type==="mousemove"?(i=e.clientX,r=e.clientY,t=e.pageX,s=e.pageY,o=e.target):e.type==="touchmove"&&(i=e.touches[0].clientX,r=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,o=document.elementFromPoint(i,r)),this.moveInputState===u.pieceClickedThreshold||this.moveInputState===u.secondClickThreshold)(Math.abs(this.startPoint.x-i)>ye||Math.abs(this.startPoint.y-r)>ye)&&(this.moveInputState===u.secondClickThreshold?this.setMoveInputState(u.clickDragTo,{square:this.fromSquare,piece:this.movedPiece}):this.setMoveInputState(u.dragTo,{square:this.fromSquare,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled()&&this.moveDraggablePiece(t,s));else if(this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo||this.moveInputState===u.clickTo){if(o&&o.getAttribute&&o.parentElement===this.view.boardGroup){const n=o.getAttribute("data-square");n!==this.fromSquare&&n!==this.toSquare?(this.toSquare=n,this.movingOverSquareCallback(this.fromSquare,this.toSquare)):n===this.fromSquare&&this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null))}else this.toSquare!==null&&(this.toSquare=null,this.movingOverSquareCallback(this.fromSquare,null));this.view.chessboard.state.inputEnabled()&&(this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){const s=t.getAttribute("data-square");if(s)this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo?this.fromSquare===s?this.moveInputState===u.clickDragTo?(this.chessboard.state.position.setPiece(this.fromSquare,this.movedPiece),this.view.setPieceVisibility(this.fromSquare),this.moveInputCanceledCallback(s,null,J.draggedBack),this.setMoveInputState(u.reset)):this.setMoveInputState(u.clickTo,{square:s}):this.setMoveInputState(u.moveDone,{square:s}):this.moveInputState===u.pieceClickedThreshold?this.setMoveInputState(u.clickTo,{square:s}):this.moveInputState===u.secondClickThreshold&&(this.setMoveInputState(u.reset),this.moveInputCanceledCallback(s,null,J.secondClick));else{this.view.redrawPieces();const i=this.fromSquare;this.setMoveInputState(u.reset),this.moveInputCanceledCallback(i,null,J.movedOutOfBoard)}}else this.view.redrawPieces(),this.setMoveInputState(u.reset)}onContextMenu(e){e.preventDefault(),this.view.redrawPieces(),this.setMoveInputState(u.reset),this.moveInputCanceledCallback(this.fromSquare,null,J.secondaryClick)}isDragging(){return this.moveInputState===u.dragTo||this.moveInputState===u.clickDragTo}destroy(){this.setMoveInputState(u.reset)}}const L={white:"w",black:"b"},R={moveInputStarted:"moveInputStarted",movingOverSquare:"movingOverSquare",validateMoveInput:"validateMoveInput",moveInputCanceled:"moveInputCanceled",moveInputFinished:"moveInputFinished"},Fe={pointerdown:"pointerdown"},Q={none:"none",thin:"thin",frame:"frame"};class Ue{constructor(e){this.chessboard=e,this.visualMoveInput=new Be(this),e.props.assetsCache&&this.cacheSpriteToDiv("cm-chessboard-sprite",this.getSpriteUrl()),this.container=document.createElement("div"),this.chessboard.context.appendChild(this.container),e.props.responsive&&(typeof ResizeObserver<"u"?(this.resizeObserver=new ResizeObserver(()=>{setTimeout(()=>{this.handleResize()})}),this.resizeObserver.observe(this.chessboard.context)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.positionsAnimationTask=Promise.resolve(),this.pointerDownListener=this.pointerDownHandler.bind(this),this.container.addEventListener("mousedown",this.pointerDownListener),this.container.addEventListener("touchstart",this.pointerDownListener,{passive:!1}),this.createSvgAndGroups(),this.handleResize()}pointerDownHandler(e){this.visualMoveInput.onPointerDown(e)}destroy(){this.visualMoveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.context),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.context.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.context.removeEventListener("touchstart",this.pointerDownListener),b.removeElement(this.svg),this.container.remove()}cacheSpriteToDiv(e,t){if(!document.getElementById(e)){const s=document.createElement("div");s.style.transform="scale(0)",s.style.position="absolute",s.setAttribute("aria-hidden","true"),s.id=e,document.body.appendChild(s);const i=new XMLHttpRequest;i.open("GET",t,!0),i.onload=function(){s.insertAdjacentHTML("afterbegin",i.response)},i.send()}}createSvgAndGroups(){this.svg=b.createSvg(this.container);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.svg.setAttribute("role","img"),this.updateMetrics(),this.boardGroup=b.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=b.addElement(this.svg,"g",{class:"coordinates","aria-hidden":"true"}),this.markersLayer=b.addElement(this.svg,"g",{class:"markers-layer"}),this.piecesLayer=b.addElement(this.svg,"g",{class:"pieces-layer"}),this.piecesGroup=b.addElement(this.piecesLayer,"g",{class:"pieces"}),this.markersTopLayer=b.addElement(this.svg,"g",{class:"markers-top-layer"}),this.interactiveTopLayer=b.addElement(this.svg,"g",{class:"interactive-top-layer"})}updateMetrics(){const e=this.chessboard.props.style.pieces.tileSize;this.width=this.container.clientWidth,this.height=this.container.clientWidth*(this.chessboard.props.style.aspectRatio||1),this.chessboard.props.style.borderType===Q.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===Q.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/e,this.scalingY=this.squareHeight/e,this.pieceXTranslate=this.squareWidth/2-e*this.scalingY/2}handleResize(){this.container.style.width=this.chessboard.context.clientWidth+"px",this.container.style.height=this.chessboard.context.clientWidth*this.chessboard.props.style.aspectRatio+"px",(this.container.clientWidth!==this.width||this.container.clientHeight!==this.height)&&(this.updateMetrics(),this.redrawBoard(),this.redrawPieces()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")}redrawBoard(){this.chessboard.state.invokeExtensionPoints(w.beforeRedrawBoard),this.redrawSquares(),this.drawCoordinates(),this.chessboard.state.invokeExtensionPoints(w.afterRedrawBoard),this.visualizeInputState()}redrawSquares(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(b.addElement(this.boardGroup,"rect",{width:this.width,height:this.height}).setAttribute("class","border"),this.chessboard.props.style.borderType===Q.frame){const t=this.borderSize;b.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2}).setAttribute("class","border-inner")}for(let t=0;t<64;t++){const s=this.chessboard.state.orientation===L.white?t:63-t,r=`square ${(9*s&8)===0?"black":"white"}`,o=this.squareToPoint(y.indexToSquare(s)),n=b.addElement(this.boardGroup,"rect",{x:o.x,y:o.y,width:this.squareWidth,height:this.squareHeight});n.setAttribute("class",r),n.setAttribute("data-square",y.indexToSquare(s))}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);const e=this.chessboard.props.style.borderType!==Q.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.style.pieces.tileSize*t)*this.scalingX,i=this.height-this.scalingY*3.5,r="coordinate file";e&&(s=s+this.scalingX*15.5,r+=t%2?" white":" black");const o=b.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===L.white?o.textContent=String.fromCharCode(97+t):o.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,i=this.borderSize+25*this.scalingY+t*this.squareHeight,r="coordinate rank";e&&(r+=t%2?" black":" white",this.chessboard.props.style.borderType===Q.frame?(s=s+this.scalingX*10,i=i-this.scalingY*15):(s=s+this.scalingX*2,i=i-this.scalingY*15));const o=b.addElement(this.coordinatesGroup,"text",{class:r,x:s,y:i,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===L.white?o.textContent=""+(8-t):o.textContent=""+(1+t)}}redrawPieces(e=this.chessboard.state.position.squares){const t=Array.from(this.piecesGroup.childNodes),s=this.visualMoveInput.isDragging();for(let i=0;i<64;i++){const r=e[i];if(r){const o=y.indexToSquare(i);this.drawPieceOnSquare(o,r,s&&o===this.visualMoveInput.fromSquare)}}for(const i of t)this.piecesGroup.removeChild(i)}drawPiece(e,t,s){const i=b.addElement(e,"g",{});i.setAttribute("data-piece",t);const r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),i.transform.baseVal.appendItem(r);const o=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),n=b.addElement(i,"use",{href:`${o}#${t}`,class:"piece"}),a=this.svg.createSVGTransform();return a.setScale(this.scalingY,this.scalingY),n.transform.baseVal.appendItem(a),i}drawPieceOnSquare(e,t,s=!1){const i=b.addElement(this.piecesGroup,"g",{});i.setAttribute("data-piece",t),i.setAttribute("data-square",e),s&&i.setAttribute("visibility","hidden");const r=this.squareToPoint(e),o=this.svg.createSVGTransform();o.setTranslate(r.x,r.y),i.transform.baseVal.appendItem(o);const n=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),a=b.addElement(i,"use",{href:`${n}#${t}`,class:"piece"}),c=this.svg.createSVGTransform();c.setTranslate(this.pieceXTranslate,0),a.transform.baseVal.appendItem(c);const f=this.svg.createSVGTransform();return f.setScale(this.scalingY,this.scalingY),a.transform.baseVal.appendItem(f),i}setPieceVisibility(e,t=!0){const s=this.getPieceElement(e);s?t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden"):console.warn("no piece on",e)}getPieceElement(e){if(!e||e.length<2)return console.warn("invalid square",e),null;const t=this.piecesGroup.querySelector(`g[data-square='${e}']`);return t||(console.warn("no piece on",e),null)}enableMoveInput(e,t=null){if(this.chessboard.state.moveInputCallback)throw Error("moveInput already enabled");t===L.white?this.chessboard.state.inputWhiteEnabled=!0:t===L.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.moveInputCallback=e,this.chessboard.state.invokeExtensionPoints(w.moveInputToggled,{enabled:!0,color:t}),this.visualizeInputState()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.moveInputCallback=null,this.chessboard.state.invokeExtensionPoints(w.moveInputToggled,{enabled:!1}),this.visualizeInputState()}moveInputStartedCallback(e){const t={chessboard:this.chessboard,type:R.moveInputStarted,square:e,squareFrom:e,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(t.moveInputCallbackResult=this.chessboard.state.moveInputCallback(t)),this.chessboard.state.invokeExtensionPoints(w.moveInput,t),t.moveInputCallbackResult}movingOverSquareCallback(e,t){const s={chessboard:this.chessboard,type:R.movingOverSquare,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(w.moveInput,s)}validateMoveInputCallback(e,t){const s={chessboard:this.chessboard,type:R.validateMoveInput,squareFrom:e,squareTo:t,piece:this.chessboard.getPiece(e)};return this.chessboard.state.moveInputCallback&&(s.moveInputCallbackResult=this.chessboard.state.moveInputCallback(s)),this.chessboard.state.invokeExtensionPoints(w.moveInput,s),s.moveInputCallbackResult}moveInputCanceledCallback(e,t,s){const i={chessboard:this.chessboard,type:R.moveInputCanceled,reason:s,squareFrom:e,squareTo:t};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(w.moveInput,i)}moveInputFinishedCallback(e,t,s){const i={chessboard:this.chessboard,type:R.moveInputFinished,squareFrom:e,squareTo:t,legalMove:s};this.chessboard.state.moveInputCallback&&this.chessboard.state.moveInputCallback(i),this.chessboard.state.invokeExtensionPoints(w.moveInput,i)}visualizeInputState(){this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))}indexToPoint(e){let t,s;return this.chessboard.state.orientation===L.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}squareToPoint(e){const t=y.squareToIndex(e);return this.indexToPoint(t)}getSpriteUrl(){return z.isAbsoluteUrl(this.chessboard.props.style.pieces.file)?this.chessboard.props.style.pieces.file:this.chessboard.props.assetsUrl+this.chessboard.props.style.pieces.file}}const G={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"},Ge={svgSprite:"svgSprite"};class Ke{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.context=e,this.id=(Math.random()+1).toString(36).substring(2,8),this.extensions=[],this.props={position:X.empty,orientation:L.white,responsive:!0,assetsUrl:"./assets/",assetsCache:!0,style:{cssClass:"default",showCoordinates:!0,borderType:Q.none,aspectRatio:1,pieces:{type:Ge.svgSprite,file:"pieces/standard.svg",tileSize:40},animationDuration:300},extensions:[]},z.mergeObjects(this.props,t),this.state=new De,this.view=new Ue(this),this.positionAnimationsQueue=new Re(this),this.state.orientation=this.props.orientation;for(const s of this.props.extensions)this.addExtension(s.class,s.props);this.view.redrawBoard(),this.state.position=new y(this.props.position),this.view.redrawPieces(),this.state.invokeExtensionPoints(w.positionChanged),this.initialized=Promise.resolve()}async setPiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.setPiece(e,t),this.state.invokeExtensionPoints(w.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async movePiece(e,t,s=!1){const i=this.state.position.clone();return this.state.position.movePiece(e,t),this.state.invokeExtensionPoints(w.positionChanged),this.positionAnimationsQueue.enqueuePositionChange(i,this.state.position.clone(),s)}async setPosition(e,t=!1){const s=this.state.position.clone(),i=new y(e);return s.getFen()!==i.getFen()&&(this.state.position.setFen(e),this.state.invokeExtensionPoints(w.positionChanged)),this.positionAnimationsQueue.enqueuePositionChange(s,this.state.position.clone(),t)}async setOrientation(e,t=!1){const s=this.state.position.clone();if(this.boardTurning){console.warn("setOrientation is only once in queue allowed");return}return this.boardTurning=!0,this.positionAnimationsQueue.enqueueTurnBoard(s,e,t).then(()=>{this.boardTurning=!1,this.state.invokeExtensionPoints(w.boardChanged)})}getPiece(e){return this.state.position.getPiece(e)}getPosition(){return this.state.position.getFen()}getOrientation(){return this.state.orientation}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}isMoveInputEnabled(){return this.state.inputWhiteEnabled||this.state.inputBlackEnabled}enableSquareSelect(e=Fe.pointerdown,t){this.squareSelectListener||(this.squareSelectListener=function(s){const i=s.target.getAttribute("data-square");t({eventType:s.type,event:s,chessboard:this,square:i})}),this.context.addEventListener(e,this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.visualizeInputState()}disableSquareSelect(e){this.context.removeEventListener(e,this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.visualizeInputState()}isSquareSelectEnabled(){return this.state.squareSelectEnabled}addExtension(e,t){if(this.getExtension(e))throw Error('extension "'+e.name+'" already added');this.extensions.push(new e(this,t))}getExtension(e){for(const t of this.extensions)if(t instanceof e)return t;return null}destroy(){this.state.invokeExtensionPoints(w.destroy),this.positionAnimationsQueue.destroy(),this.view.destroy(),this.view=void 0,this.state=void 0}}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const I="w",O="b",q="p",ge="n",ae="b",te="r",W="q",P="k",ce="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class re{constructor(e,t){_(this,"color");_(this,"from");_(this,"to");_(this,"piece");_(this,"captured");_(this,"promotion");_(this,"flags");_(this,"san");_(this,"lan");_(this,"before");_(this,"after");const{color:s,piece:i,from:r,to:o,flags:n,captured:a,promotion:c}=t,f=T(r),v=T(o);this.color=s,this.piece=i,this.from=f,this.to=v,this.san=e._moveToSan(t,e._moves({legal:!0})),this.lan=f+v,this.before=e.fen(),e._makeMove(t),this.after=e.fen(),e._undoMove(),this.flags="";for(const l in m)m[l]&n&&(this.flags+=j[l]);a&&(this.captured=a),c&&(this.promotion=c,this.lan+=c)}isCapture(){return this.flags.indexOf(j.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(j.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(j.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(j.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(j.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(j.BIG_PAWN)>-1}}const A=-1,j={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},m={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},be={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},He={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},We={...be,...He},p={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ue={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ce={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ze=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],$e=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],je={p:1,n:2,b:4,r:8,q:16,k:32},Qe="pnbrqkPNBRQK",Pe=[ge,ae,te,W],Ve=7,Ye=6,Xe=1,Je=0,oe={[P]:m.KSIDE_CASTLE,[W]:m.QSIDE_CASTLE},K={w:[{square:p.a1,flag:m.QSIDE_CASTLE},{square:p.h1,flag:m.KSIDE_CASTLE}],b:[{square:p.a8,flag:m.QSIDE_CASTLE},{square:p.h8,flag:m.KSIDE_CASTLE}]},Ze={b:Xe,w:Ye},et=["1-0","0-1","1/2-1/2","*"];function V(h){return h>>4}function se(h){return h&15}function Me(h){return"0123456789".indexOf(h)!==-1}function T(h){const e=se(h),t=V(h);return"abcdefgh".substring(e,e+1)+"87654321".substring(t,t+1)}function Z(h){return h===I?O:I}function tt(h){const e=h.split(/\s+/);if(e.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(e[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(e[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=e[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let o=0;o<i.length;o++){let n=0,a=!1;for(let c=0;c<i[o].length;c++)if(Me(i[o][c])){if(a)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};n+=parseInt(i[o][c],10),a=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[o][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};n+=1,a=!1}if(n!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(e[3][1]=="3"&&e[1]=="w"||e[3][1]=="6"&&e[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:o,regex:n}of r){if(!n.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${o} king`};if((e[0].match(n)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${o} kings`}}return Array.from(i[0]+i[7]).some(o=>o.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function st(h,e){const t=h.from,s=h.to,i=h.piece;let r=0,o=0,n=0;for(let a=0,c=e.length;a<c;a++){const f=e[a].from,v=e[a].to,l=e[a].piece;i===l&&t!==f&&s===v&&(r++,V(t)===V(f)&&o++,se(t)===se(f)&&n++)}return r>0?o>0&&n>0?T(t):n>0?T(t).charAt(1):T(t).charAt(0):""}function H(h,e,t,s,i,r=void 0,o=m.NORMAL){const n=V(s);if(i===q&&(n===Ve||n===Je))for(let a=0;a<Pe.length;a++){const c=Pe[a];h.push({color:e,from:t,to:s,piece:i,captured:r,promotion:c,flags:o|m.PROMOTION})}else h.push({color:e,from:t,to:s,piece:i,captured:r,flags:o})}function qe(h){let e=h.charAt(0);return e>="a"&&e<="h"?h.match(/[a-h]\d.*[a-h]\d/)?void 0:q:(e=e.toLowerCase(),e==="o"?P:e)}function de(h){return h.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function pe(h){return h.split(" ").slice(0,4).join(" ")}class it{constructor(e=ce,{skipValidation:t=!1}={}){_(this,"_board",new Array(128));_(this,"_turn",I);_(this,"_header",{});_(this,"_kings",{w:A,b:A});_(this,"_epSquare",-1);_(this,"_halfMoves",0);_(this,"_moveNumber",0);_(this,"_history",[]);_(this,"_comments",{});_(this,"_castling",{w:0,b:0});_(this,"_positionCount",{});this.load(e,{skipValidation:t})}clear({preserveHeaders:e=!1}={}){this._board=new Array(128),this._kings={w:A,b:A},this._turn=I,this._castling={w:0,b:0},this._epSquare=A,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=e?this._header:{...We},this._positionCount={},this._header.SetUp=null,this._header.FEN=null}load(e,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let i=e.split(/\s+/);if(i.length>=2&&i.length<6){const n=["-","-","0","1"];e=i.concat(n.slice(-(6-i.length))).join(" ")}if(i=e.split(/\s+/),!t){const{ok:n,error:a}=tt(e);if(!n)throw new Error(a)}const r=i[0];let o=0;this.clear({preserveHeaders:s});for(let n=0;n<r.length;n++){const a=r.charAt(n);if(a==="/")o+=8;else if(Me(a))o+=parseInt(a,10);else{const c=a<"a"?I:O;this._put({type:a.toLowerCase(),color:c},T(o)),o++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=m.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=m.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=m.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=m.QSIDE_CASTLE),this._epSquare=i[3]==="-"?A:p[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._updateSetup(e),this._incPositionCount(e)}fen(){var r,o;let e=0,t="";for(let n=p.a8;n<=p.h1;n++){if(this._board[n]){e>0&&(t+=e,e=0);const{color:a,type:c}=this._board[n];t+=a===I?c.toUpperCase():c.toLowerCase()}else e++;n+1&136&&(e>0&&(t+=e),n!==p.h1&&(t+="/"),e=0,n+=8)}let s="";this._castling[I]&m.KSIDE_CASTLE&&(s+="K"),this._castling[I]&m.QSIDE_CASTLE&&(s+="Q"),this._castling[O]&m.KSIDE_CASTLE&&(s+="k"),this._castling[O]&m.QSIDE_CASTLE&&(s+="q"),s=s||"-";let i="-";if(this._epSquare!==A){const n=this._epSquare+(this._turn===I?16:-16),a=[n+1,n-1];for(const c of a){if(c&136)continue;const f=this._turn;if(((r=this._board[c])==null?void 0:r.color)===f&&((o=this._board[c])==null?void 0:o.type)===q){this._makeMove({color:f,from:c,to:this._epSquare,piece:q,captured:q,flags:m.EP_CAPTURE});const v=!this._isKingAttacked(f);if(this._undoMove(),v){i=T(this._epSquare);break}}}}return[t,this._turn,s,i,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(e){this._history.length>0||(e!==ce?(this._header.SetUp="1",this._header.FEN=e):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(ce)}get(e){return this._board[p[e]]}findPiece(e){var s;const t=[];for(let i=p.a8;i<=p.h1;i++){if(i&136){i+=7;continue}!this._board[i]||((s=this._board[i])==null?void 0:s.color)!==e.color||this._board[i].color===e.color&&this._board[i].type===e.type&&t.push(T(i))}return t}put({type:e,color:t},s){return this._put({type:e,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_put({type:e,color:t},s){if(Qe.indexOf(e.toLowerCase())===-1||!(s in p))return!1;const i=p[s];if(e==P&&!(this._kings[t]==A||this._kings[t]==i))return!1;const r=this._board[i];return r&&r.type===P&&(this._kings[r.color]=A),this._board[i]={type:e,color:t},e===P&&(this._kings[t]=i),!0}remove(e){const t=this.get(e);return delete this._board[p[e]],t&&t.type===P&&(this._kings[t.color]=A),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){var s,i,r,o,n,a,c,f,v,l,E,d;const e=((s=this._board[p.e1])==null?void 0:s.type)===P&&((i=this._board[p.e1])==null?void 0:i.color)===I,t=((r=this._board[p.e8])==null?void 0:r.type)===P&&((o=this._board[p.e8])==null?void 0:o.color)===O;(!e||((n=this._board[p.a1])==null?void 0:n.type)!==te||((a=this._board[p.a1])==null?void 0:a.color)!==I)&&(this._castling.w&=-65),(!e||((c=this._board[p.h1])==null?void 0:c.type)!==te||((f=this._board[p.h1])==null?void 0:f.color)!==I)&&(this._castling.w&=-33),(!t||((v=this._board[p.a8])==null?void 0:v.type)!==te||((l=this._board[p.a8])==null?void 0:l.color)!==O)&&(this._castling.b&=-65),(!t||((E=this._board[p.h8])==null?void 0:E.type)!==te||((d=this._board[p.h8])==null?void 0:d.color)!==O)&&(this._castling.b&=-33)}_updateEnPassantSquare(){var r,o;if(this._epSquare===A)return;const e=this._epSquare+(this._turn===I?-16:16),t=this._epSquare+(this._turn===I?16:-16),s=[t+1,t-1];if(this._board[e]!==null||this._board[this._epSquare]!==null||((r=this._board[t])==null?void 0:r.color)!==Z(this._turn)||((o=this._board[t])==null?void 0:o.type)!==q){this._epSquare=A;return}const i=n=>{var a,c;return!(n&136)&&((a=this._board[n])==null?void 0:a.color)===this._turn&&((c=this._board[n])==null?void 0:c.type)===q};s.some(i)||(this._epSquare=A)}_attacked(e,t,s){const i=[];for(let r=p.a8;r<=p.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==e)continue;const o=this._board[r],n=r-t;if(n===0)continue;const a=n+119;if(ze[a]&je[o.type]){if(o.type===q){if(n>0&&o.color===I||n<=0&&o.color===O)if(s)i.push(T(r));else return!0;continue}if(o.type==="n"||o.type==="k")if(s){i.push(T(r));continue}else return!0;const c=$e[a];let f=r+c,v=!1;for(;f!==t;){if(this._board[f]!=null){v=!0;break}f+=c}if(!v)if(s){i.push(T(r));continue}else return!0}}return s?i:!1}attackers(e,t){return t?this._attacked(t,p[e],!0):this._attacked(this._turn,p[e],!0)}_isKingAttacked(e){const t=this._kings[e];return t===-1?!1:this._attacked(Z(e),t)}isAttacked(e,t){return this._attacked(t,p[e])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const e={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let s=0,i=0;for(let r=p.a8;r<=p.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}const o=this._board[r];o&&(e[o.type]=o.type in e?e[o.type]+1:1,o.type===ae&&t.push(i),s++)}if(s===2)return!0;if(s===3&&(e[ae]===1||e[ge]===1))return!0;if(s===e[ae]+2){let r=0;const o=t.length;for(let n=0;n<o;n++)r+=t[n];if(r===0||r===o)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this.fen())>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:e=!1,square:t=void 0,piece:s=void 0}={}){const i=this._moves({square:t,piece:s});return e?i.map(r=>new re(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:e=!0,piece:t=void 0,square:s=void 0}={}){var E;const i=s?s.toLowerCase():void 0,r=t==null?void 0:t.toLowerCase(),o=[],n=this._turn,a=Z(n);let c=p.a8,f=p.h1,v=!1;if(i)if(i in p)c=f=p[i],v=!0;else return[];for(let d=c;d<=f;d++){if(d&136){d+=7;continue}if(!this._board[d]||this._board[d].color===a)continue;const{type:S}=this._board[d];let k;if(S===q){if(r&&r!==S)continue;k=d+ue[n][0],this._board[k]||(H(o,n,d,k,q),k=d+ue[n][1],Ze[n]===V(d)&&!this._board[k]&&H(o,n,d,k,q,void 0,m.BIG_PAWN));for(let M=2;M<4;M++)k=d+ue[n][M],!(k&136)&&(((E=this._board[k])==null?void 0:E.color)===a?H(o,n,d,k,q,this._board[k].type,m.CAPTURE):k===this._epSquare&&H(o,n,d,k,q,q,m.EP_CAPTURE))}else{if(r&&r!==S)continue;for(let M=0,$=Ce[S].length;M<$;M++){const g=Ce[S][M];for(k=d;k+=g,!(k&136);){if(!this._board[k])H(o,n,d,k,S);else{if(this._board[k].color===n)break;H(o,n,d,k,S,this._board[k].type,m.CAPTURE);break}if(S===ge||S===P)break}}}}if((r===void 0||r===P)&&(!v||f===this._kings[n])){if(this._castling[n]&m.KSIDE_CASTLE){const d=this._kings[n],S=d+2;!this._board[d+1]&&!this._board[S]&&!this._attacked(a,this._kings[n])&&!this._attacked(a,d+1)&&!this._attacked(a,S)&&H(o,n,this._kings[n],S,P,void 0,m.KSIDE_CASTLE)}if(this._castling[n]&m.QSIDE_CASTLE){const d=this._kings[n],S=d-2;!this._board[d-1]&&!this._board[d-2]&&!this._board[d-3]&&!this._attacked(a,this._kings[n])&&!this._attacked(a,d-1)&&!this._attacked(a,S)&&H(o,n,this._kings[n],S,P,void 0,m.QSIDE_CASTLE)}}if(!e||this._kings[n]===-1)return o;const l=[];for(let d=0,S=o.length;d<S;d++)this._makeMove(o[d]),this._isKingAttacked(n)||l.push(o[d]),this._undoMove();return l}move(e,{strict:t=!1}={}){let s=null;if(typeof e=="string")s=this._moveFromSan(e,t);else if(typeof e=="object"){const r=this._moves();for(let o=0,n=r.length;o<n;o++)if(e.from===T(r[o].from)&&e.to===T(r[o].to)&&(!("promotion"in r[o])||e.promotion===r[o].promotion)){s=r[o];break}}if(!s)throw typeof e=="string"?new Error(`Invalid move: ${e}`):new Error(`Invalid move: ${JSON.stringify(e)}`);const i=new re(this,s);return this._makeMove(s),this._incPositionCount(i.after),i}_push(e){this._history.push({move:e,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(e){const t=this._turn,s=Z(t);if(this._push(e),this._board[e.to]=this._board[e.from],delete this._board[e.from],e.flags&m.EP_CAPTURE&&(this._turn===O?delete this._board[e.to-16]:delete this._board[e.to+16]),e.promotion&&(this._board[e.to]={type:e.promotion,color:t}),this._board[e.to].type===P){if(this._kings[t]=e.to,e.flags&m.KSIDE_CASTLE){const i=e.to-1,r=e.to+1;this._board[i]=this._board[r],delete this._board[r]}else if(e.flags&m.QSIDE_CASTLE){const i=e.to+1,r=e.to-2;this._board[i]=this._board[r],delete this._board[r]}this._castling[t]=0}if(this._castling[t]){for(let i=0,r=K[t].length;i<r;i++)if(e.from===K[t][i].square&&this._castling[t]&K[t][i].flag){this._castling[t]^=K[t][i].flag;break}}if(this._castling[s]){for(let i=0,r=K[s].length;i<r;i++)if(e.to===K[s][i].square&&this._castling[s]&K[s][i].flag){this._castling[s]^=K[s][i].flag;break}}e.flags&m.BIG_PAWN?t===O?this._epSquare=e.to-16:this._epSquare=e.to+16:this._epSquare=A,e.piece===q?this._halfMoves=0:e.flags&(m.CAPTURE|m.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===O&&this._moveNumber++,this._turn=s}undo(){const e=this._undoMove();if(e){const t=new re(this,e);return this._decPositionCount(t.after),t}return null}_undoMove(){const e=this._history.pop();if(e===void 0)return null;const t=e.move;this._kings=e.kings,this._turn=e.turn,this._castling=e.castling,this._epSquare=e.epSquare,this._halfMoves=e.halfMoves,this._moveNumber=e.moveNumber;const s=this._turn,i=Z(s);if(this._board[t.from]=this._board[t.to],this._board[t.from].type=t.piece,delete this._board[t.to],t.captured)if(t.flags&m.EP_CAPTURE){let r;s===O?r=t.to-16:r=t.to+16,this._board[r]={type:q,color:i}}else this._board[t.to]={type:t.captured,color:i};if(t.flags&(m.KSIDE_CASTLE|m.QSIDE_CASTLE)){let r,o;t.flags&m.KSIDE_CASTLE?(r=t.to+1,o=t.to-1):(r=t.to-2,o=t.to+1),this._board[r]=this._board[o],delete this._board[o]}return t}pgn({newline:e=`
`,maxWidth:t=0}={}){const s=[];let i=!1;for(const l in this._header)this._header[l]&&s.push(`[${l} "${this._header[l]}"]`+e),i=!0;i&&this._history.length&&s.push(e);const r=l=>{const E=this._comments[this.fen()];if(typeof E<"u"){const d=l.length>0?" ":"";l=`${l}${d}{${E}}`}return l},o=[];for(;this._history.length>0;)o.push(this._undoMove());const n=[];let a="";for(o.length===0&&n.push(r(""));o.length>0;){a=r(a);const l=o.pop();if(!l)break;if(!this._history.length&&l.color==="b"){const E=`${this._moveNumber}. ...`;a=a?`${a} ${E}`:E}else l.color==="w"&&(a.length&&n.push(a),a=this._moveNumber+".");a=a+" "+this._moveToSan(l,this._moves({legal:!0})),this._makeMove(l)}if(a.length&&n.push(r(a)),n.push(this._header.Result||"*"),t===0)return s.join("")+n.join(" ");const c=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},f=function(l,E){for(const d of E.split(" "))if(d){if(l+d.length>t){for(;c();)l--;s.push(e),l=0}s.push(d),l+=d.length,s.push(" "),l++}return c()&&l--,l};let v=0;for(let l=0;l<n.length;l++){if(v+n[l].length>t&&n[l].includes("{")){v=f(v,n[l]);continue}v+n[l].length>t&&l!==0?(s[s.length-1]===" "&&s.pop(),s.push(e),v=0):l!==0&&(s.push(" "),v++),s.push(n[l]),v+=n[l].length}return s.join("")}header(...e){for(let t=0;t<e.length;t+=2)typeof e[t]=="string"&&typeof e[t+1]=="string"&&(this._header[e[t]]=e[t+1]);return this._header}setHeader(e,t){return this._header[e]=t??be[e]??null,this.getHeaders()}removeHeader(e){return e in this._header?(this._header[e]=be[e]||null,!0):!1}getHeaders(){const e={};for(const[t,s]of Object.entries(this._header))s!==null&&(e[t]=s);return e}loadPgn(e,{strict:t=!1,newlineChar:s=`\r?
`}={}){function i(g){return g.replace(/\\/g,"\\")}function r(g){const D={},U=g.split(new RegExp(i(s)));let he="",_e="";for(let ie=0;ie<U.length;ie++){const we=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;he=U[ie].replace(we,"$1"),_e=U[ie].replace(we,"$2"),he.trim().length>0&&(D[he]=_e)}return D}e=e.trim();const n=new RegExp("^(\\[((?:"+i(s)+")|.)*\\])((?:\\s*"+i(s)+"){2}|(?:\\s*"+i(s)+")*$)").exec(e),a=n&&n.length>=2?n[1]:"";this.reset();const c=r(a);let f="";for(const g in c)g.toLowerCase()==="fen"&&(f=c[g]),this.header(g,c[g]);if(!t)f&&this.load(f,{preserveHeaders:!0});else if(c.SetUp==="1"){if(!("FEN"in c))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(c.FEN,{preserveHeaders:!0})}function v(g){return Array.from(g).map(function(D){return D.charCodeAt(0)<128?D.charCodeAt(0).toString(16):encodeURIComponent(D).replace(/%/g,"").toLowerCase()}).join("")}function l(g){return g.length==0?"":decodeURIComponent("%"+(g.match(/.{1,2}/g)||[]).join("%"))}const E=function(g){return g=g.replace(new RegExp(i(s),"g")," "),`{${v(g.slice(1,g.length-1))}}`},d=function(g){if(g.startsWith("{")&&g.endsWith("}"))return l(g.slice(1,g.length-1))};let S=e.replace(a,"").replace(new RegExp(`({[^}]*})+?|;([^${i(s)}]*)`,"g"),function(g,D,U){return D!==void 0?E(D):" "+E(`{${U.slice(1)}}`)}).replace(new RegExp(i(s),"g")," ");const k=/(\([^()]+\))+?/g;for(;k.test(S);)S=S.replace(k,"");S=S.replace(/\d+\.(\.\.)?/g,""),S=S.replace(/\.\.\./g,""),S=S.replace(/\$\d+/g,"");let M=S.trim().split(new RegExp(/\s+/));M=M.filter(g=>g!=="");let $="";for(let g=0;g<M.length;g++){const D=d(M[g]);if(D!==void 0){this._comments[this.fen()]=D;continue}const U=this._moveFromSan(M[g],t);if(U==null)if(et.indexOf(M[g])>-1)$=M[g];else throw new Error(`Invalid move in PGN: ${M[g]}`);else $="",this._makeMove(U),this._incPositionCount(this.fen())}$&&Object.keys(this._header).length&&this._header.Result!==$&&this.setHeader("Result",$)}_moveToSan(e,t){let s="";if(e.flags&m.KSIDE_CASTLE)s="O-O";else if(e.flags&m.QSIDE_CASTLE)s="O-O-O";else{if(e.piece!==q){const i=st(e,t);s+=e.piece.toUpperCase()+i}e.flags&(m.CAPTURE|m.EP_CAPTURE)&&(e.piece===q&&(s+=T(e.from)[0]),s+="x"),s+=T(e.to),e.promotion&&(s+="="+e.promotion.toUpperCase())}return this._makeMove(e),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(e,t=!1){const s=de(e);let i=qe(s),r=this._moves({legal:!0,piece:i});for(let l=0,E=r.length;l<E;l++)if(s===de(this._moveToSan(r[l],r)))return r[l];if(t)return null;let o,n,a,c,f,v=!1;if(n=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),n?(o=n[1],a=n[2],c=n[3],f=n[4],a.length==1&&(v=!0)):(n=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),n&&(o=n[1],a=n[2],c=n[3],f=n[4],a.length==1&&(v=!0))),i=qe(s),r=this._moves({legal:!0,piece:o||i}),!c)return null;for(let l=0,E=r.length;l<E;l++)if(a){if((!o||o.toLowerCase()==r[l].piece)&&p[a]==r[l].from&&p[c]==r[l].to&&(!f||f.toLowerCase()==r[l].promotion))return r[l];if(v){const d=T(r[l].from);if((!o||o.toLowerCase()==r[l].piece)&&p[c]==r[l].to&&(a==d[0]||a==d[1])&&(!f||f.toLowerCase()==r[l].promotion))return r[l]}}else if(s===de(this._moveToSan(r[l],r)).replace("x",""))return r[l];return null}ascii(){let e=`   +------------------------+
`;for(let t=p.a8;t<=p.h1;t++){if(se(t)===0&&(e+=" "+"87654321"[V(t)]+" |"),this._board[t]){const s=this._board[t].type,r=this._board[t].color===I?s.toUpperCase():s.toLowerCase();e+=" "+r+" "}else e+=" . ";t+1&136&&(e+=`|
`,t+=8)}return e+=`   +------------------------+
`,e+="     a  b  c  d  e  f  g  h",e}perft(e){const t=this._moves({legal:!1});let s=0;const i=this._turn;for(let r=0,o=t.length;r<o;r++)this._makeMove(t[r]),this._isKingAttacked(i)||(e-1>0?s+=this.perft(e-1):s++),this._undoMove();return s}turn(){return this._turn}board(){const e=[];let t=[];for(let s=p.a8;s<=p.h1;s++)this._board[s]==null?t.push(null):t.push({square:T(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(e.push(t),t=[],s+=8);return e}squareColor(e){if(e in p){const t=p[e];return(V(t)+se(t))%2===0?"light":"dark"}return null}history({verbose:e=!1}={}){const t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const i=t.pop();if(!i)break;e?s.push(new re(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(e){const t=pe(e);return this._positionCount[t]||0}_incPositionCount(e){const t=pe(e);this._positionCount[t]===void 0&&(this._positionCount[t]=0),this._positionCount[t]+=1}_decPositionCount(e){const t=pe(e);this._positionCount[t]===1?delete this._positionCount[t]:this._positionCount[t]-=1}_pruneComments(){const e=[],t={},s=i=>{i in this._comments&&(t[i]=this._comments[i])};for(;this._history.length>0;)e.push(this._undoMove());for(s(this.fen());;){const i=e.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(e){this._comments[this.fen()]=e.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const e=this._comments[this.fen()];return delete this._comments[this.fen()],e}getComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>({fen:e,comment:this._comments[e]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(e=>{const t=this._comments[e];return delete this._comments[e],{fen:e,comment:t}})}setCastlingRights(e,t){for(const i of[P,W])t[i]!==void 0&&(t[i]?this._castling[e]|=oe[i]:this._castling[e]&=~oe[i]);this._updateCastlingRights();const s=this.getCastlingRights(e);return(t[P]===void 0||t[P]===s[P])&&(t[W]===void 0||t[W]===s[W])}getCastlingRights(e){return{[P]:(this._castling[e]&oe[P])!==0,[W]:(this._castling[e]&oe[W])!==0}}moveNumber(){return this._moveNumber}}const N={hidden:"hidden",displayRequested:"displayRequested",shown:"shown"},fe={pieceSelected:"pieceSelected",canceled:"canceled"};class rt extends Te{constructor(e){super(e),this.registerExtensionPoint(w.afterRedrawBoard,this.extensionPointRedrawBoard.bind(this)),e.showPromotionDialog=this.showPromotionDialog.bind(this),e.isPromotionDialogShown=this.isPromotionDialogShown.bind(this),this.promotionDialogGroup=b.addElement(e.view.interactiveTopLayer,"g",{class:"promotion-dialog-group"}),this.state={displayState:N.hidden,callback:null,dialogParams:{square:null,color:null}}}showPromotionDialog(e,t,s){this.state.dialogParams.square=e,this.state.dialogParams.color=t,this.state.callback=s,this.setDisplayState(N.displayRequested),setTimeout(()=>{this.chessboard.view.positionsAnimationTask.then(()=>{this.setDisplayState(N.shown)})})}isPromotionDialogShown(){return this.state.displayState===N.shown||this.state.displayState===N.displayRequested}extensionPointRedrawBoard(){this.redrawDialog()}drawPieceButton(e,t){const s=this.chessboard.view.squareWidth,i=this.chessboard.view.squareHeight;b.addElement(this.promotionDialogGroup,"rect",{x:t.x,y:t.y,width:s,height:i,class:"promotion-dialog-button","data-piece":e}),this.chessboard.view.drawPiece(this.promotionDialogGroup,e,t)}redrawDialog(){for(;this.promotionDialogGroup.firstChild;)this.promotionDialogGroup.removeChild(this.promotionDialogGroup.firstChild);if(this.state.displayState===N.shown){const e=this.chessboard.view.squareWidth,t=this.chessboard.view.squareHeight,s=this.chessboard.view.squareToPoint(this.state.dialogParams.square);s.x=s.x+e/2,s.y=s.y+t/2;let i=!1;const r=parseInt(this.state.dialogParams.square.charAt(1),10);(this.chessboard.getOrientation()===L.white&&r<5||this.chessboard.getOrientation()===L.black&&r>=5)&&(i=!0);const o=i?-4*t:0,n=s.x+e>this.chessboard.view.width?-e:0;b.addElement(this.promotionDialogGroup,"rect",{x:s.x+n,y:s.y+o,width:e,height:t*4,class:"promotion-dialog"});const a=this.state.dialogParams;i?(this.drawPieceButton(G[a.color+"q"],{x:s.x+n,y:s.y-t}),this.drawPieceButton(G[a.color+"r"],{x:s.x+n,y:s.y-t*2}),this.drawPieceButton(G[a.color+"b"],{x:s.x+n,y:s.y-t*3}),this.drawPieceButton(G[a.color+"n"],{x:s.x+n,y:s.y-t*4})):(this.drawPieceButton(G[a.color+"q"],{x:s.x+n,y:s.y}),this.drawPieceButton(G[a.color+"r"],{x:s.x+n,y:s.y+t}),this.drawPieceButton(G[a.color+"b"],{x:s.x+n,y:s.y+t*2}),this.drawPieceButton(G[a.color+"n"],{x:s.x+n,y:s.y+t*3}))}}promotionDialogOnClickPiece(e){e.button!==2&&(e.target.dataset.piece?(this.state.callback&&this.state.callback({type:fe.pieceSelected,square:this.state.dialogParams.square,piece:e.target.dataset.piece}),this.setDisplayState(N.hidden)):this.promotionDialogOnCancel(e))}promotionDialogOnCancel(e){this.state.displayState===N.shown&&(e.preventDefault(),this.setDisplayState(N.hidden),this.state.callback&&this.state.callback({type:fe.canceled}))}contextMenu(e){e.preventDefault(),this.setDisplayState(N.hidden),this.state.callback&&this.state.callback({type:fe.canceled})}setDisplayState(e){this.state.displayState=e,e===N.shown?(this.clickDelegate=z.delegate(this.chessboard.view.svg,"pointerdown","*",this.promotionDialogOnClickPiece.bind(this)),this.contextMenuListener=this.contextMenu.bind(this),this.chessboard.view.svg.addEventListener("contextmenu",this.contextMenuListener)):e===N.hidden&&(this.clickDelegate.remove(),this.chessboard.view.svg.removeEventListener("contextmenu",this.contextMenuListener)),this.redrawDialog()}}const ee={frame:{class:"marker-frame",slice:"markerFrame"},dot:{class:"marker-dot",slice:"markerDot",position:"above"},bevel:{class:"marker-bevel",slice:"markerBevel"}};class ot extends Te{constructor(e,t={}){super(e),this.registerExtensionPoint(w.afterRedrawBoard,()=>{this.onRedrawBoard()}),this.props={autoMarkers:ee.frame,sprite:"extensions/markers/markers.svg"},Object.assign(this.props,t),e.props.assetsCache&&e.view.cacheSpriteToDiv("cm-chessboard-markers",this.getSpriteUrl()),e.addMarker=this.addMarker.bind(this),e.getMarkers=this.getMarkers.bind(this),e.removeMarkers=this.removeMarkers.bind(this),e.addLegalMovesMarkers=this.addLegalMovesMarkers.bind(this),e.removeLegalMovesMarkers=this.removeLegalMovesMarkers.bind(this),this.markerGroupDown=b.addElement(e.view.markersLayer,"g",{class:"markers"}),this.markerGroupUp=b.addElement(e.view.markersTopLayer,"g",{class:"markers"}),this.markers=[],this.props.autoMarkers&&(Object.assign(this.props.autoMarkers,this.props.autoMarkers),this.registerExtensionPoint(w.moveInput,s=>{this.drawAutoMarkers(s)}))}drawAutoMarkers(e){e.type!==R.moveInputFinished&&this.removeMarkers(this.props.autoMarkers),!(e.type===R.moveInputStarted&&!e.moveInputCallbackResult)&&(e.type===R.moveInputStarted||e.type===R.movingOverSquare)&&(e.squareFrom&&this.addMarker(this.props.autoMarkers,e.squareFrom),e.squareTo&&this.addMarker(this.props.autoMarkers,e.squareTo))}onRedrawBoard(){for(;this.markerGroupUp.firstChild;)this.markerGroupUp.removeChild(this.markerGroupUp.firstChild);for(;this.markerGroupDown.firstChild;)this.markerGroupDown.removeChild(this.markerGroupDown.firstChild);this.markers.forEach(e=>{this.drawMarker(e)})}addLegalMovesMarkers(e){for(const t of e)t.promotion&&t.promotion!=="q"||(this.chessboard.getPiece(t.to)?this.chessboard.addMarker(ee.bevel,t.to):this.chessboard.addMarker(ee.dot,t.to))}removeLegalMovesMarkers(){this.chessboard.removeMarkers(ee.bevel),this.chessboard.removeMarkers(ee.dot)}drawMarker(e){let t;e.type.position==="above"?t=b.addElement(this.markerGroupUp,"g"):t=b.addElement(this.markerGroupDown,"g"),t.setAttribute("data-square",e.square);const s=this.chessboard.view.squareToPoint(e.square),i=this.chessboard.view.svg.createSVGTransform();i.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(i);const r=this.chessboard.props.assetsCache?"":this.getSpriteUrl(),o=b.addElement(t,"use",{href:`${r}#${e.type.slice}`,class:"marker "+e.type.class}),n=this.chessboard.view.svg.createSVGTransform();return n.setScale(this.chessboard.view.scalingX,this.chessboard.view.scalingY),o.transform.baseVal.appendItem(n),t}addMarker(e,t){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `addMarker` to `(type, square)` with v5.1.x");return}this.markers.push(new nt(t,e)),this.onRedrawBoard()}getMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `getMarkers` to `(type, square)` with v5.1.x");return}let s=[];return this.markers.forEach(i=>{i.matches(t,e)&&s.push(i)}),s}removeMarkers(e=void 0,t=void 0){if(typeof e=="string"||typeof t=="object"){console.error("changed the signature of `removeMarkers` to `(type, square)` with v5.1.x");return}this.markers=this.markers.filter(s=>!s.matches(t,e)),this.onRedrawBoard()}getSpriteUrl(){return z.isAbsoluteUrl(this.props.sprite)?this.props.sprite:this.chessboard.props.assetsUrl+this.props.sprite}}class nt{constructor(e,t){this.square=e,this.type=t}matches(e=void 0,t=void 0){if(!t&&!e)return!0;if(t){if(e){if(this.type===t&&e===this.square)return!0}else if(this.type===t)return!0}else if(e===this.square)return!0;return!1}}const B=new Worker("stockfish.js");Ae();const xe=document.getElementById("checkmate"),Ie=document.getElementById("historyTable"),x=new it,at={class:"marker-circle-danger",slice:"markerCircleDanger"},ne={class:"move-dot",slice:"moveDot"},C=new Ke(document.getElementById("board"),{position:X.start,assetsUrl:"/chess-site/assets/",style:{borderType:Q.frame},extensions:[{class:rt},{class:ot}]});C.enableMoveInput(ht);function ht(h){if(h.type===R.moveInputStarted){if(h.square===h.squareFrom){C.removeMarkers();const t=x.moves({square:h.square});for(let s of t)s.includes("+")?C.addMarker(ne,s.slice(-3,-1)):s==="O-O"?C.addMarker(ne,C.getOrientation()==="w"?"g1":"g8"):s==="O-O-O"?C.addMarker(ne,C.getOrientation()==="w"?"c1":"c8"):C.addMarker(ne,s.slice(-2))}return!0}if(h.type===R.validateMoveInput){const e={from:h.squareFrom,to:h.squareTo};return(e.to.charAt(1)==="8"||e.to.charAt(1)==="1")&&h.piece.charAt(1)==="p"?C.showPromotionDialog(e.to,e.to.charAt(1)==="8"?L.white:L.black,s=>{s&&s.piece&&(e.promotion=s.piece.charAt(1),ve(e))}):ve(e),!1}}async function ve(h,e){try{x.move(h),await C.movePiece(h.from,h.to,!0),C.removeMarkers()}catch{return console.log("Invalid Move: "+h.from+" to "+h.to+" "+h.promotion),!1}if(C.setPosition(x.fen()),e||ke(),Se(),x.inCheck()){const t=x.turn()===I?I:O,s={type:P,color:t},i=x.findPiece(s);C.addMarker(at,i[0])}x.isCheckmate()&&(xe.style.display="flex")}function lt(){xe.style.display="none",C.removeMarkers(),x.reset(),C.setPosition(X.start),B.postMessage("position startpos"),Ae(C.getOrientation()==="w"),C.getOrientation()==="b"&&ke(),Se()}function ct(){C.setPosition(x.fen())}function Se(){Ie.innerHTML="";const h=x.history();for(let e=0;e<h.length/2;e++){let t=document.createElement("tr"),s=document.createElement("td"),i=document.createElement("td");s.innerText=h[e*2],h[e*2+1]&&(i.innerText=h[e*2+1]),t.appendChild(s),t.appendChild(i),Ie.appendChild(t)}}function ut(){x.undo(),x.turn()!==C.getOrientation()&&x.undo(),B.postMessage("position "+x.fen())}function dt(){const h=C.getOrientation()===L.white?L.black:L.white;C.setOrientation(h),B.postMessage("flip"),ke()}function Ae(h){B.postMessage("ucinewgame"),B.postMessage("position startpos"),B.postMessage("setoption name UCI_LimitStrength value true"),h||B.postMessage("flip")}function ke(){console.log("position "+x.fen()),B.postMessage("position fen "+x.fen()),B.postMessage("go depth 1")}B.onmessage=function(h){if(console.log(h),h.data.includes("bestmove")){const e=h.data.slice(9,13);ve({from:e.slice(0,2),to:e.slice(2,4)},!0)}};const me=document.querySelector("input");me.addEventListener("change",h=>{console.log("setoption name Skill Level value "+me.value),B.postMessage("setoption name Skill Level value "+me.value)});const pt=document.getElementById("checkmate"),ft=document.body.getElementsByTagName("button");for(let h of ft)h.addEventListener("mouseenter",()=>{h.style.color="white"}),h.addEventListener("mouseleave",()=>{h.style.color="#c5a076"});playAgain.addEventListener("click",()=>{pt.style.display="none"});startAgain.addEventListener("click",()=>{lt()});undo.addEventListener("click",()=>{ut(),ct(),Se()});swapSides.addEventListener("click",()=>{dt()});
